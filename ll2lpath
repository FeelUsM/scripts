#! /bin/bash

# todo переписать все нахрен с использованием <dirent.h> и <sys/stat.h>

printhelp()
{
    cat >&2 <<EOF
	ll2lpath - сканирует текущий каталог
	создает -p в нем папку .files/
	а в ней файл с именем в виде даты времени
	содержащий в каждой строчке 
		размер файла в байтах,
		время создания файла в секундах с 1970 года
		путь/имя файла
	если в процессе сканирования возикли ошибки доступа или что-то в этом роде
	он записывает это в файл с именем в виде даты времени-log
	и сообщает "SAPID" (грязно)
EOF
	exit $1
}

[ "$1" == -h -o "$1" == --help ] && printhelp 0

datetime=$(date '+%F-%H:%M:%S')
files=.files/$datetime-files
dirs=.files/$datetime-dirs
oldfiles="$(ls -1 .files/20*-files .files/19*-files .files/21*-files 2>/dev/null | sort -r | head -n 1)"
olddirs=${oldfiles%-files}-dirs


mkdir -p .files
ls -alR --time-style=+%s    2>.files/ls-log | tee >(grep '^./' > $dirs) |
    runcpp ll2lpath-internal.c $files .files/log .files .sync .git
[ "${PIPESTATUS[2]}" != 0 ] && exit 1

if  [ -s "$oldfiles" -a -s "$olddirs" ] && 
	[ $(ls -1 .files/20*-files .files/19*-files .files/21*-files 2>/dev/null | wc -l) -gt 2 ] &&
	[ "$(diff $oldfiles $files)" == "" -a "$(diff $olddirs $dirs)" == "" ]; then
	rm $files $dirs
	echo ничего нового
else
	echo $files $dirs >> .files/list
	echo созданы $files $dirs
	if  [ -s "$oldfiles" -a -s "$olddirs" ] ; then
		diff $oldfiles $files -u0 | runcpp diffiles-internal.cpp
		diff $olddirs $dirs
	fi
fi
	
if [ -s .files/log -o -s .files/ls-log  ]; then # -s - существует и не пуст 
    echo =============== SAPID =============
    cat .files/log .files/ls-log | tee .files/$datetime-log	
fi
	
rm .files/log .files/ls-log
